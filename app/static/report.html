<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Usage Summary</title>
  </head>
  <body>
    <h1>Usage Summary</h1>

    <button id="show-stats-btn">Show usage summary</button>

    <p id="stats-total"></p>

    <h2>Per operation</h2>
    <table border="1">
      <thead>
        <tr>
          <th>Operation</th>
          <th>Count</th>
        </tr>
      </thead>
      <tbody id="stats-per-operation"></tbody>
    </table>

    <script>
      async function loadSummary() {
        const totalEl = document.getElementById("stats-total");
        const perOpEl = document.getElementById("stats-per-operation");

        // Try both possible keys: "token" and "access_token"
        const storedToken =
          localStorage.getItem("token") ||
          localStorage.getItem("access_token");

        if (!storedToken) {
          totalEl.textContent =
            "You must be logged in to see the report.";
          perOpEl.innerHTML = "";
          return;
        }

        // Make sure we send "Bearer <token>"
        const authHeader = storedToken.startsWith("Bearer ")
          ? storedToken
          : `Bearer ${storedToken}`;

        try {
          const resp = await fetch("/reports/summary", {
            method: "GET",
            headers: {
              Authorization: authHeader,
              "Content-Type": "application/json",
            },
          });

          if (!resp.ok) {
            totalEl.textContent =
              "Failed to load summary (" + resp.status + ")";
            perOpEl.innerHTML = "";
            return;
          }

          const data = await resp.json();

          totalEl.textContent =
            "Total calculations: " + data.total_calculations;

          perOpEl.innerHTML = "";

          if (data.per_operation.length === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 2;
            td.textContent = "No calculations yet.";
            tr.appendChild(td);
            perOpEl.appendChild(tr);
            return;
          }

          for (const row of data.per_operation) {
            const tr = document.createElement("tr");

            const tdOp = document.createElement("td");
            tdOp.textContent = row.operator;

            const tdCount = document.createElement("td");
            tdCount.textContent = row.count.toString();

            tr.appendChild(tdOp);
            tr.appendChild(tdCount);
            perOpEl.appendChild(tr);
          }
        } catch (err) {
          console.error(err);
          totalEl.textContent = "Error loading summary.";
          perOpEl.innerHTML = "";
        }
      }

      document
        .getElementById("show-stats-btn")
        .addEventListener("click", loadSummary);
    </script>
  </body>
</html>
